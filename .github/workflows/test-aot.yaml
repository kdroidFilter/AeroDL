name: Test Packaging

on:
  pull_request:
    paths:
      - 'composeApp/build.gradle.kts'
      - '.github/workflows/test-aot.yaml'

jobs:
  test-packaging:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x64
          - os: ubuntu-24.04-arm
            name: Linux ARM64
          - os: macos-latest
            name: macOS ARM64
          - os: macos-15-intel
            name: macOS Intel
          - os: windows-latest
            name: Windows x64
          - os: windows-11-arm
            name: Windows ARM64

    name: Package - ${{ matrix.name }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Nucleus
        uses: kdroidFilter/Nucleus/.github/actions/setup-nucleus@v1.1.1
        with:
          packaging-tools: 'true'
          setup-gradle: 'true'

      - name: Verify JDK
        shell: bash
        run: java -version

      - name: Clean npm cache (Windows ARM workaround)
        if: runner.os == 'Windows'
        shell: bash
        run: npm cache clean --force

      - name: Build installer
        shell: bash
        run: |
          chmod +x ./gradlew
          ./gradlew :composeApp:packageReleaseDistributionForCurrentOS --stacktrace --no-daemon
